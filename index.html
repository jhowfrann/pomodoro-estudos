<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pomodoro de Estudos</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .card { border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px; }
  .grid { display: grid; gap: 5px; }
  .grid-cols-2 { grid-template-columns: 1fr 1fr; }
  .btn { padding: 5px 10px; margin-right: 5px; cursor: pointer; }
  .hidden { display: none; }
  .meta { font-size: 0.9em; color: #555; }
</style>
</head>
<body>
<h1>Pomodoro de Estudos</h1>
<div id="userInfo"></div>
<button id="btnLogin">Entrar com Google</button>
<button id="btnLogout" class="hidden">Sair</button>

<hr>
<h2>Cadastro de Disciplinas</h2>
<section id="pageDisciplinas">
  <div class="grid">
    <div>
      <label for="concurso">Concurso / Trilha de Estudos</label>
      <input id="concurso" placeholder="Ex.: TCE, CNU, Concurso XYZ" />
    </div>
    <div>
      <label for="nome">Nome da disciplina</label>
      <input id="nome" placeholder="Ex.: Cálculo, Inglês" />
    </div>
    <div class="grid grid-cols-2">
      <div>
        <label for="estudo">Minutos de estudo</label>
        <input id="estudo" type="number" min="1" value="50" />
      </div>
      <div>
        <label for="pausa">Minutos de pausa</label>
        <input id="pausa" type="number" min="1" value="10" />
      </div>
    </div>
    <div class="row">
      <button id="btnAdd" class="btn">Adicionar</button>
      <button id="btnSaveEdit" class="btn hidden">Salvar edição</button>
      <button id="btnCancelEdit" class="btn secondary hidden">Cancelar</button>
    </div>
  </div>
  <div id="listaDisciplinas"></div>
</section>

<hr>
<h2>Execução</h2>
<div>
  <div>Disciplina Atual: <span id="disciplinaAtual">—</span></div>
  <div>Concurso / Trilha: <span id="concursoAtual">—</span></div>
  <div>Fase: <span id="fasePill">—</span></div>
  <div>Timer: <span id="timer">00:00</span></div>
  <button id="btnStart">Iniciar</button>
  <button id="btnPause">Pausar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";

// --- Configuração Firebase ---
const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI.firebaseapp.com",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI.appspot.com",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const $ = id => document.getElementById(id);
let user = null;
let disciplinas = [];
let idx = 0;
let fase = 'estudo';
let segundos = 0;
let timerInterval = null;
let editId = null;

// --- Login Google ---
const provider = new GoogleAuthProvider();
btnLogin.addEventListener('click', async ()=>{
  const result = await signInWithPopup(auth, provider);
  user = result.user;
});
btnLogout.addEventListener('click', async ()=>{
  await signOut(auth);
  user = null;
  location.reload();
});

onAuthStateChanged(auth, async (u)=>{
  user = u;
  if(user){
    $('btnLogin').classList.add('hidden');
    $('btnLogout').classList.remove('hidden');
    $('userInfo').innerText = 'Logado como: ' + user.email;
    await carregarDisciplinas();
  } else {
    $('btnLogin').classList.remove('hidden');
    $('btnLogout').classList.add('hidden');
  }
});

// --- CRUD Disciplinas ---
$('#btnAdd').addEventListener('click', async ()=>{
  if(!user) return alert('Faça login com Google.');
  const nome = $('#nome').value.trim();
  const estudo = parseInt($('#estudo').value,10);
  const pausa = parseInt($('#pausa').value,10);
  const concurso = $('#concurso').value.trim();
  if(!nome || !estudo || !pausa || !concurso) return alert('Preencha todos os campos.');

  await addDoc(collection(db, 'users', user.uid, 'subjects'), {
    concurso, nome, estudo, pausa, concluidas:0, orderIndex: Date.now(), createdAt: serverTimestamp()
  });
  resetEditor();
  await carregarDisciplinas();
});

const resetEditor = ()=>{
  $('#nome').value=''; $('#estudo').value=50; $('#pausa').value=10; $('#concurso').value='';
  $('#btnSaveEdit').classList.add('hidden');
  $('#btnCancelEdit').classList.add('hidden');
  $('#btnAdd').classList.remove('hidden');
  editId = null;
}

async function carregarDisciplinas(){
  const snap = await getDocs(collection(db, 'users', user.uid, 'subjects'));
  disciplinas = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.orderIndex-b.orderIndex);
  paintLista();
}

function paintLista(){
  const lista = $('listaDisciplinas');
  lista.innerHTML='';
  disciplinas.forEach(d=>{
    lista.innerHTML += `
      <div class="card">
        <div class="title">${d.nome}</div>
        <div class="meta">Concurso / Trilha: ${d.concurso}</div>
        <div class="time">${d.estudo} + ${d.pausa} min</div>
        <div class="actions">
          <button onclick="editSubject('${d.id}')">Editar</button>
          <button onclick="deleteSubject('${d.id}')">Excluir</button>
        </div>
      </div>
    `;
  });
}

window.editSubject = async (id)=>{
  const d = disciplinas.find(x=>x.id===id);
  if(!d) return;
  $('#nome').value = d.nome;
  $('#estudo').value = d.estudo;
  $('#pausa').value = d.pausa;
  $('#concurso').value = d.concurso;
  editId = id;
  $('#btnSaveEdit').classList.remove('hidden');
  $('#btnCancelEdit').classList.remove('hidden');
  $('#btnAdd').classList.add('hidden');
}

$('#btnSaveEdit').addEventListener('click', async ()=>{
  if(!user || !editId) return;
  const nome = $('#nome').value.trim();
  const estudo = parseInt($('#estudo').value,10);
  const pausa = parseInt($('#pausa').value,10);
  const concurso = $('#concurso').value.trim();
  if(!nome || !estudo || !pausa || !concurso) return alert('Preencha todos os campos.');
  await updateDoc(doc(db,'users',user.uid,'subjects',editId),{nome,estudo,pausa,concurso});
  resetEditor();
  await carregarDisciplinas();
});

$('#btnCancelEdit').addEventListener('click', resetEditor);

window.deleteSubject = async (id)=>{
  if(!confirm('Deseja excluir esta disciplina?')) return;
  await deleteDoc(doc(db,'users',user.uid,'subjects',id));
  await carregarDisciplinas();
}

// --- Execução Pomodoro ---
$('#btnStart').addEventListener('click', ()=>{ if(!timerInterval) startTimer(); });
$('#btnPause').addEventListener('click', ()=>{ clearInterval(timerInterval); timerInterval=null; });

function fmt(s){ const m=Math.floor(s/60); const sec=s%60; return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`; }

function startTimer(){
  if(!disciplinas.length) return alert('Cadastre disciplinas primeiro.');
  segundos = fase==='estudo'? disciplinas[idx].estudo*60 : disciplinas[idx].pausa*60;
  paintExec();
  timerInterval = setInterval(()=>{
    segundos--;
    paintExec();
    if(segundos<=0){
      clearInterval(timerInterval);
      timerInterval=null;
      if(fase==='estudo'){ disciplinas[idx].concluidas++; fase='pausa'; }
      else { fase='estudo'; idx++; if(idx>=disciplinas.length) idx=0; }
      startTimer();
    }
  },1000);
}

function paintExec(){
  const d = disciplinas[idx];
  if(!d){
    $('disciplinaAtual').innerText='—';
    $('fasePill').innerText='—';
    $('timer').innerText='00:00';
    $('concursoAtual').innerText='—';
    return;
  }
  $('disciplinaAtual').innerText=d.nome;
  $('concursoAtual').innerText=d.concurso;
  $('fasePill').innerText=fase==='estudo'?'Estudo':'Pausa';
  $('timer').innerText=fmt(segundos);
}
</script>
</body>
</html>
