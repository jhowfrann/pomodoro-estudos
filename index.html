<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro de Estudos</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2937; --accent:#2563eb; --muted:#6b7280; --border:#e5e7eb; --soft:#eef2f7;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --accent:#3b82f6; --muted:#94a3b8; --border:#1f2937; --soft:#0b1220;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:var(--card);box-shadow:0 2px 12px rgba(0,0,0,.08);position:sticky;top:0;z-index:20}
    header h1{margin:0;font-size:18px}
    .auth{display:flex;gap:8px;align-items:center}
    .btn{border:0;padding:10px 12px;border-radius:12px;background:var(--accent);color:#fff;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--soft);color:var(--text)}
    .btn.danger{background:#ef4444}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .container{max-width:1000px;margin:20px auto;padding:0 12px}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab-active{outline:2px solid var(--accent)}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
    .grid{display:grid;gap:12px}
    @media (min-width:780px){ .grid-cols-2{grid-template-columns:1fr 1fr} }
    input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);outline:none}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    ul{list-style:none;margin:0;padding:0}
    li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;background:var(--card)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meta{color:var(--muted);font-size:12px}
    .pill{background:#eef2ff;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
    [data-theme="dark"] .pill{background:#1e3a8a;color:#dbeafe}
    .hidden{display:none}
    .title{margin:0 0 8px 0;font-size:18px}
    .timer{font-size:52px;font-weight:900;letter-spacing:2px;text-align:center}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:var(--soft);border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body data-theme="light">
  <header>
    <h1>Pomodoro de Estudos</h1>
    <div class="auth">
      <span id="userLabel" class="meta">Desconectado</span>
      <button id="btnSignIn" class="btn">Entrar com Google</button>
      <button id="btnSignOut" class="btn secondary hidden">Sair</button>
      <button id="btnTheme" class="btn secondary" title="Alternar tema">üåì</button>
    </div>
  </header>

  <div class="container">
    <nav class="tabs">
      <button class="btn secondary tab-active" id="tabConcurso">üèÜ Concurso/Trilha</button>
      <button class="btn secondary" id="tabDisciplinas">üìò Disciplinas</button>
      <button class="btn secondary" id="tabExecucao">‚è± Execu√ß√£o</button>
    </nav>

    <!-- 1) CONCURSO / TRILHA -->
    <section id="pageConcurso">
      <div class="card">
        <h2 class="title">Cadastrar Concurso / Trilha</h2>
        <div class="grid grid-cols-2">
          <div>
            <label for="nomeConcurso">Nome do Concurso / Trilha</label>
            <input id="nomeConcurso" placeholder="Ex.: TCE, CNU, Concurso XYZ" />
            <div class="hint">Dica: use nomes curtos. Ex.: ‚ÄúPF-ADM‚Äù, ‚ÄúTRT-24‚Äù.</div>
          </div>
          <div class="row" style="align-self:end;">
            <button id="btnAddConcurso" class="btn">Adicionar</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <h2 class="title">Minhas Trilhas</h2>
          <div class="meta">Selecione uma trilha para gerenciar disciplinas e executar o Pomodoro.</div>
        </div>
        <ul id="listaConcursos"></ul>
      </div>
      <div class="meta">Ciclos conclu√≠dos (todas as trilhas): <b id="ciclosCount">0</b></div>
    </section>

    <!-- 2) DISCIPLINAS -->
    <section id="pageDisciplinas" class="hidden">
      <div class="card">
        <h2 class="title">Cadastrar / Editar Disciplina</h2>
        <div class="grid">
          <div>
            <label for="selectConcurso">Concurso / Trilha</label>
            <select id="selectConcurso"></select>
          </div>
          <div>
            <label for="nome">Nome da disciplina</label>
            <input id="nome" placeholder="Ex.: Portugu√™s, RLM, Direito Adm." />
          </div>
          <div class="grid grid-cols-2">
            <div>
              <label for="estudo">Minutos de estudo</label>
              <input id="estudo" type="number" min="1" value="50" />
            </div>
            <div>
              <label for="pausa">Minutos de pausa</label>
              <input id="pausa" type="number" min="1" value="10" />
            </div>
          </div>
          <div class="row">
            <button id="btnAddDisciplina" class="btn">Adicionar</button>
            <button id="btnSaveEdit" class="btn hidden">Salvar edi√ß√£o</button>
            <button id="btnCancelEdit" class="btn secondary hidden">Cancelar</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h2 class="title">Disciplinas da Trilha</h2>
        <ul id="listaDisciplinas"></ul>
      </div>
    </section>

    <!-- 3) EXECU√á√ÉO -->
    <section id="pageExecucao" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="meta">Concurso / Trilha</div>
            <h2 id="execConcursoNome" class="title">‚Äî</h2>
          </div>
          <div>
            <div class="meta">Fase</div>
            <span id="fasePill" class="pill">‚Äî</span>
          </div>
        </div>
        <div class="timer" id="timerDisplay">00:00</div>
        <div class="row" style="justify-content:center;gap:12px;margin-top:12px;">
          <button id="btnStart" class="btn">Iniciar</button>
          <button id="btnPause" class="btn secondary" disabled>Pausar</button>
          <button id="btnStop" class="btn danger" disabled>Parar</button>
        </div>
      </div>
      <div class="card">
        <h2 class="title">Fila de Execu√ß√£o</h2>
        <ul id="filaExec"></ul>
      </div>
    </section>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.15.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.15.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "COLE_AQUI",
      authDomain: "SEU_FIREBASE.firebaseapp.com",
      projectId: "SEU_FIREBASE",
      storageBucket: "SEU_FIREBASE.appspot.com",
      messagingSenderId: "COLE_AQUI",
      appId: "COLE_AQUI"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);

    let currentUser = null;
    let selectedConcurso = null;
    let editDisciplinaId = null;
    let timerInterval = null;
    let timerRemaining = 0;
    let timerPhase = "estudo"; // estudo/pausa
    let filaExec = [];

    const themeToggle = () => {
      const theme = document.body.getAttribute('data-theme') === 'light' ? 'dark':'light';
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    };

    $('btnTheme').onclick = themeToggle;
    const savedTheme = localStorage.getItem('theme');
    if(savedTheme) document.body.setAttribute('data-theme', savedTheme);

    // ------------ AUTH ----------------
    $('btnSignIn').onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch(e){ alert('Falha no login: '+e.message) }
    };

    $('btnSignOut').onclick = async () => { await signOut(auth); stopAll(); };

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if(user){
        $('userLabel').innerText = user.displayName;
        $('btnSignIn').classList.add('hidden');
        $('btnSignOut').classList.remove('hidden');
        initUserData();
      } else {
        $('userLabel').innerText = 'Desconectado';
        $('btnSignIn').classList.remove('hidden');
        $('btnSignOut').classList.add('hidden');
        selectedConcurso = null;
        $('listaConcursos').innerHTML = '';
        $('selectConcurso').innerHTML = '';
        $('listaDisciplinas').innerHTML = '';
        $('filaExec').innerHTML = '';
        $('ciclosCount').innerText = 0;
      }
    });

    // ------------ DADOS ----------------
    async function initUserData(){
      const uref = doc(db,'users',currentUser.uid);
      const snap = await getDoc(uref);
      if(!snap.exists()) await setDoc(uref,{cyclesCompleted:0,createdAt:serverTimestamp()});
      // Atualiza contador global
      onSnapshot(uref,(s)=>{ $('ciclosCount').innerText = s.data()?.cyclesCompleted || 0; });

      loadConcursos();
    }

    async function loadConcursos(){
      const q = collection(db,'users',currentUser.uid,'concursos');
      onSnapshot(q,(snap)=>{
        const list = $('listaConcursos'); list.innerHTML=''; 
        const sel = $('selectConcurso'); sel.innerHTML='';
        snap.forEach(docu=>{
          const data = docu.data();
          // lista
          const li = document.createElement('li'); 
          li.innerHTML=`<span>${data.nome}</span>
            <div class="row">
              <button class="btn secondary" onclick="selectConcurso('${docu.id}','${data.nome}')">Selecionar</button>
              <button class="btn danger" onclick="deleteConcurso('${docu.id}')">Excluir</button>
            </div>`;
          list.appendChild(li);
          // select
          const op = document.createElement('option');
          op.value=docu.id; op.innerText=data.nome;
          sel.appendChild(op);
        });
      });
    }

    window.selectConcurso = async (id,nome)=>{
      selectedConcurso=id;
      $('execConcursoNome').innerText=nome;
      loadDisciplinas();
    }

    async function deleteConcurso(id){
      if(!confirm('Excluir trilha e todas as disciplinas?')) return;
      await deleteDoc(doc(db,'users',currentUser.uid,'concursos',id));
      const disps = collection(db,'users',currentUser.uid,'concursos',id,'disciplinas');
      const snap = await getDocs(disps);
      snap.forEach(d=>deleteDoc(d.ref));
      if(selectedConcurso===id) selectedConcurso=null;
    }

    // ------------ DISCIPLINAS ----------------
    $('btnAddDisciplina').onclick = async ()=>{
      const nome=$('nome').value.trim();
      const minEstudo=Number($('estudo').value);
      const minPausa=Number($('pausa').value);
      const concursoId = $('selectConcurso').value;
      if(!nome||!concursoId) return alert('Informe trilha e nome da disciplina');
      await addDoc(collection(db,'users',currentUser.uid,'concursos',concursoId,'disciplinas'),{
        nome, estudo:minEstudo, pausa:minPausa, createdAt:serverTimestamp()
      });
      $('nome').value=''; $('estudo').value=50; $('pausa').value=10;
    };

    async function loadDisciplinas(){
      if(!selectedConcurso) return;
      const q = collection(db,'users',currentUser.uid,'concursos',selectedConcurso,'disciplinas');
      onSnapshot(q,(snap)=>{
        const ul = $('listaDisciplinas'); ul.innerHTML='';
        snap.forEach(docu=>{
          const d=docu.data();
          const li=document.createElement('li');
          li.innerHTML=`<span>${d.nome} (${d.estudo}min / ${d.pausa}min)</span>
            <div class="row">
              <button class="btn secondary" onclick="addFilaExec('${docu.id}','${d.nome}',${d.estudo},${d.pausa})">Fila</button>
              <button class="btn danger" onclick="deleteDisciplina('${docu.id}')">Excluir</button>
            </div>`;
          ul.appendChild(li);
        });
      });
    }

    window.deleteDisciplina = async (id)=>{
      if(!selectedConcurso) return;
      await deleteDoc(doc(db,'users',currentUser.uid,'concursos',selectedConcurso,'disciplinas',id));
    }

    // ------------ FILA DE EXECU√á√ÉO ----------------
    window.addFilaExec=(id,nome,estudo,pausa)=>{
      filaExec.push({id,nome,estudo,pausa});
      renderFilaExec();
    }

    function renderFilaExec(){
      const ul=$('filaExec'); ul.innerHTML='';
      filaExec.forEach((f,idx)=>{
        const li=document.createElement('li');
        li.innerHTML=`<span>${f.nome} (${f.estudo}min/${f.pausa}min)</span>
          <button class="btn danger" onclick="removeFila(${idx})">‚úñ</button>`;
        ul.appendChild(li);
      });
    }

    window.removeFila=(idx)=>{ filaExec.splice(idx,1); renderFilaExec(); }

    // ------------ POMODORO ----------------
    $('btnStart').onclick=startTimer;
    $('btnPause').onclick=pauseTimer;
    $('btnStop').onclick=stopAll;

    function startTimer(){
      if(filaExec.length===0) return alert('Adicione disciplinas na fila');
      const atual=filaExec[0];
      timerPhase='estudo'; timerRemaining=atual.estudo*60;
      updateFasePill();
      $('btnStart').disabled=true; $('btnPause').disabled=false; $('btnStop').disabled=false;
      timerInterval=setInterval(tickTimer,1000);
    }

    function pauseTimer(){
      clearInterval(timerInterval); timerInterval=null;
      $('btnStart').disabled=false; $('btnPause').disabled=true;
    }

    function stopAll(){
      clearInterval(timerInterval); timerInterval=null; timerRemaining=0;
      $('timerDisplay').innerText='00:00';
      $('btnStart').disabled=false; $('btnPause').disabled=true; $('btnStop').disabled=true;
    }

    function tickTimer(){
      if(timerRemaining<=0){
        if(timerPhase==='estudo'){
          timerPhase='pausa';
          timerRemaining=filaExec[0].pausa*60;
          updateFasePill();
          alert('Hora da pausa!');
        } else {
          // finalizou disciplina
          alert(`Disciplina ${filaExec[0].nome} conclu√≠da!`);
          filaExec.shift();
          renderFilaExec();
          // aumenta contador global
          if(currentUser){
            const uref=doc(db,'users',currentUser.uid);
            updateDoc(uref,{cyclesCompleted:(parseInt($('ciclosCount').innerText)||0)+1});
          }
          if(filaExec.length>0){ timerPhase='estudo'; timerRemaining=filaExec[0].estudo*60; updateFasePill(); }
          else{ stopAll(); return; }
        }
      }
      const m=Math.floor(timerRemaining/60).toString().padStart(2,'0');
      const s=(timerRemaining%60).toString().padStart(2,'0');
      $('timerDisplay').innerText=`${m}:${s}`;
      timerRemaining--;
    }

    function updateFasePill(){
      $('fasePill').innerText=timerPhase==='estudo'?'Estudo':'Pausa';
    }

    // ------------ TABS ----------------
    $('tabConcurso').onclick=()=>showTab('pageConcurso');
    $('tabDisciplinas').onclick=()=>showTab('pageDisciplinas');
    $('tabExecucao').onclick=()=>showTab('pageExecucao');

    function showTab(tabId){
      ['pageConcurso','pageDisciplinas','pageExecucao'].forEach(id=>{
        $(id).classList.add('hidden');
      });
      $(tabId).classList.remove('hidden');
      document.querySelectorAll('nav.tabs button').forEach(btn=>btn.classList.remove('tab-active'));
      if(tabId==='pageConcurso') $('tabConcurso').classList.add('tab-active');
      if(tabId==='pageDisciplinas') $('tabDisciplinas').classList.add('tab-active');
      if(tabId==='pageExecucao') $('tabExecucao').classList.add('tab-active');
    }
  </script>
</body>
</html>
