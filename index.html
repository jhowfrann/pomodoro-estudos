<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Pomodoro Estudo</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #timer { font-size: 3em; margin: 20px 0; }
  button { margin: 5px; padding: 10px 20px; font-size: 1em; }
</style>
</head>
<body>

<h1>Pomodoro Estudo</h1>
<div id="user-info"></div>
<div id="timer">00:00</div>
<button id="startBtn">Iniciar</button>
<button id="pauseBtn">Pausar</button>
<button id="nextBtn">Próxima Disciplina</button>

<script>
// ====== CONFIGURAÇÃO FIREBASE ======
const firebaseConfig = {
    apiKey: "COLE_AQUI",
    authDomain: "SEU_DOMINIO.firebaseapp.com",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_PROJECT_ID.appspot.com",
    messagingSenderId: "XXXX",
    appId: "XXXX"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ====== VARIÁVEIS GLOBAIS ======
let userId = null;
let filaExec = [];
let atualIndex = 0;
let fase = "estudo";
let tempoRestante = 0;
let intervalId = null;

// ====== FUNÇÃO AUXILIAR ======
function formatTime(segundos) {
    let m = Math.floor(segundos/60).toString().padStart(2,'0');
    let s = (segundos%60).toString().padStart(2,'0');
    return `${m}:${s}`;
}

function renderTimer() {
    document.getElementById("timer").innerText = formatTime(tempoRestante);
}

// ====== FUNÇÕES FIRESTORE ======
async function salvarProgresso() {
    if (!userId) return;
    await db.collection("users").doc(userId).set({
        filaExec,
        atualIndex,
        fase,
        tempoRestante,
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    });
}

async function carregarProgresso() {
    if (!userId) return;
    const doc = await db.collection("users").doc(userId).get();
    if (doc.exists) {
        const data = doc.data();
        filaExec = data.filaExec || [];
        atualIndex = data.atualIndex || 0;
        fase = data.fase || "estudo";
        tempoRestante = data.tempoRestante || (filaExec[0]?.estudo || 1500);
        renderTimer();
    } else {
        // Inicializa com exemplo se não houver dados
        filaExec = [
            {id:"disc1", nome:"Português", estudo:50*60, pausa:10*60},
            {id:"disc2", nome:"Matemática", estudo:40*60, pausa:10*60}
        ];
        atualIndex = 0;
        fase = "estudo";
        tempoRestante = filaExec[0].estudo;
        salvarProgresso();
        renderTimer();
    }
}

// ====== FUNÇÃO TIMER ======
function iniciarTimer() {
    if (intervalId) return; // já está rodando
    intervalId = setInterval(() => {
        if (tempoRestante > 0) {
            tempoRestante--;
            renderTimer();
            salvarProgresso();
        } else {
            clearInterval(intervalId);
            intervalId = null;
            // alterna fase
            if (fase === "estudo") {
                fase = "pausa";
                tempoRestante = filaExec[atualIndex].pausa;
            } else {
                fase = "estudo";
                atualIndex++;
                if (atualIndex >= filaExec.length) atualIndex = 0;
                tempoRestante = filaExec[atualIndex].estudo;
            }
            renderTimer();
            salvarProgresso();
            iniciarTimer(); // reinicia automaticamente
        }
    }, 1000);
}

function pausarTimer() {
    clearInterval(intervalId);
    intervalId = null;
}

function proximaDisciplina() {
    clearInterval(intervalId);
    intervalId = null;
    atualIndex++;
    if (atualIndex >= filaExec.length) atualIndex = 0;
    fase = "estudo";
    tempoRestante = filaExec[atualIndex].estudo;
    renderTimer();
    salvarProgresso();
}

// ====== EVENTOS ======
document.getElementById("startBtn").onclick = iniciarTimer;
document.getElementById("pauseBtn").onclick = pausarTimer;
document.getElementById("nextBtn").onclick = proximaDisciplina;

// ====== LOGIN ANÔNIMO FIREBASE ======
auth.signInAnonymously().then(() => {
    userId = auth.currentUser.uid;
    document.getElementById("user-info").innerText = `Usuário: ${userId}`;
    carregarProgresso();
});
</script>
</body>
</html>
